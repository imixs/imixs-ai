# Imixs AI RAG

The Imixs AI RAG module provides a knowledge base system for indexing and retrieving workflow business data and metadata. The system uses **Retrieval Augmented Generation (RAG)** techniques to enable semantic search and similarity matching for given text queries.

The knowledge base is built on Apache Cassandra 4.0, providing a distributed database system with high availability and scalability.
This architecture ensures that the knowledge base can grow with the increasing enterprise data demands, while maintaining fast query performance.

This module provides:

- Cassandra-based RAG services for knowledge storage and retrieval
- Adapter and plugin classes for seamless integration into Imixs-Workflow instances
- Semantic search capabilities for workflow data

For more details about the database schema see the section [Database](./doc/DATABASE.md)

## Integration

To create, update or retrieve embeddings during a workflow live cycle the `RAGIndexPlugin` and the `RAGRetrievalAdapter` can be added to a BPMN model.
These adapter classes interact with the `OpenAIAPIService` of the module [imixs-ai-workflow](../imixs-ai-workflow/README.md) to maintain the index in a vector database.

- **RAGIndexPlugin** - the `org.imixs.ai.RAGIndexPlugin` class is used to create, update or delete embeddings.
- **RAGRetrievalAdapter** - the `org.imixs.ai.RAGRetrievalAdapter` is used to retrieve embeddings.

The imixs-rag integration supports the following mode:

- **INDEX** - Index a given prompt template and the workitem meta information.
- **UPDATE** - Update the workitem metadata (default mode).
- **PROMPT** - Perform an **Inference** a given prompt and INDEX the result.
- **DELETE** - Remove an existing RAG index for the current workitem.
- **RETRIEVAL** - Retrieve indexed embeddings based on a given prompt.

## INDEX

To index a workitem the `org.imixs.ai.RAGIndexPlugin` is used. The plugin expects an `imixs-rag` configuration and optional a BPMN DataObject `PromptDefinition` associated with the corresponding event to index a workitem:

```xml
<imixs-rag name="INDEX">
  <endpoint-embeddings>http://openai-api-server/</endpoint-embeddings>
  <debug>true</debug>
  <!-- optional -->
  <category></category>
</imixs-rag>
```

The `debug` flag is optional and can be set to `true` to log index information.

The PromptDefinition associated by a DataObject defines the text to generate the embeddings.

```xml
<?xml version="1.0" encoding="UTF-8"?>
<PromptDefinition>
  <prompt_options>{}</prompt_options>
  <prompt>
      <itemvalue>$workflowgroup</itemvalue>: <itemvalue>$workflowstatus</itemvalue>
<itemvalue>$workflowsummary</itemvalue>
# Summary
<itemvalue>$workflowabstract</itemvalue>
    </prompt>
</PromptDefinition>
```

The RAG System does not only store the embeddings but also the following Workflow Meta Information

- ModelVersion - the `$workflowgroup` item assigned to the process instance at the time of the indexing
- TaskId - the `$taskId` item assigned to the process instance at the time of the indexing

**Note:** The workflow meta information is generated at the time of the indexing and does not necessary match the current workflow status!

## PROMPT

The `PROMPT` mode enables a two-step process: text generation followed by automatic indexing. In this mode, the plugin first sends the defined prompt template to the API endpoint /v1/completion/. The text generated by the AI (the Inference result) is then automatically processed to create an embedding via the /v1/embeddings/ endpoint.

This is particularly useful for indexing AI-generated summaries or analyses instead of just the raw workitem content.

```xml
<imixs-rag name="PROMPT">
  <endpoint-embeddings>http://openai-api-embeddings/</endpoint-embeddings>
  <endpoint-completion>http://openai-api-completions/</endpoint-completion>
  <debug>true</debug>
</imixs-rag>
```

### UPDATE

To update the workflow metadata only, the `org.imixs.ai.rag.RAGIndexlugin` can be run in the 'UPDATE' mode. This is the default mode and does not need an explizit configuration. In this mode the RAGIndexPlugin automatically updates the workflow metadata in each processing life-cycle.

This plugin updates the `$workflowGroup` and `$taskId` only. These attributes can be used during the retrieval phase (see below).

**Note:** An update is only be performed if an index already exists.

### DELETE

To delete a RAG index the plugin can be used in the DELETE mode:

```xml
<rag-index name="DELETE"></rag-index>
```

This will remove the index for the current workitem.

**Note:** The `RAGService` automatically reacts on a document delete event. This means, if a workitem is deleted from the database, the embeddings index will be deleted too.

### DISABLE

The index is updated automatically in each workflow processing cycle. To disabled a metadata update in a single specific event you can define the following workflow definition:

```xml
<imixs-rag name="DISABLE"></imixs-rag>
```

In this case the plugin will be disabled.

## RETRIEVAL

To retrieve indexed embeddings by a given prompt the Signal Adapter `org.imixs.ai.RAGRetrievalAdapter` is used .
The adapter expects an `imixs-rag` configuration and a mandatory BPMN DataObject `PromptDefinition` associated with the corresponding event to index a workitem:

```xml
<imixs-rag name="RETRIEVAL">
  <endpoint-embeddings>http://openai-api-server/</endpoint-embeddings>
  <reference-item>product.ref</reference-item>
  <max-results>5</max-results>
  <modelgroups>Product</modelgroups>
  <tasks>1200</tasks>
  <debug>true</debug>
</imixs-rag>
```

The result is a list of $uniqueIDs stored in the item [reference-item]

The PromptDefinition associated by a DataObject defines the text to be used to retrieve the embeddings.

```xml
<?xml version="1.0" encoding="UTF-8"?>
<PromptDefinition>
  <prompt_options>{}</prompt_options>
  <prompt><![CDATA[<itemvalue>request.subject</itemvalue>

<FILECONTEXT>^.+\.eml$</FILECONTEXT>
]]>
</prompt>
</PromptDefinition>
```

The `debug` flag is optional and can be set to `true` to log index information.
